# Clerk JWT Template Configuration Guide

## Overview

This application uses Clerk for authentication and requires a JWT template named "convex" to properly authenticate with the Astro Shiva API backend.

## Issue Description

The application was experiencing 401 Unauthorized errors during the onboarding process because:
1. The API client (`lib/api-client.ts`) attempts to fetch a JWT token with template `'convex'`
2. This template was not configured in the Clerk dashboard
3. Without the template, authentication tokens cannot be properly generated for the backend API

## Solution

### Step 1: Create JWT Template in Clerk Dashboard

1. Go to [Clerk Dashboard](https://dashboard.clerk.com)
2. Navigate to your application
3. Go to **JWT Templates** in the left sidebar
4. Click **New Template**
5. Select **Convex** from the list of templates (or create a blank one)
6. **IMPORTANT**: Name the template exactly `convex` (lowercase)
7. Do NOT modify the default claims
8. Save the template

### Step 2: Verify Configuration

Your `.env.local` file should contain:

```env
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...
CLERK_JWT_ISSUER_DOMAIN=https://your-clerk-domain.clerk.accounts.dev
NEXT_PUBLIC_ASTRO_API_URL=https://astro-shiva-app.vercel.app
```

The `CLERK_JWT_ISSUER_DOMAIN` should match the **Issuer** URL shown in your Clerk JWT template settings.

### Step 3: Backend API Configuration

The backend API at `astro-shiva-app.vercel.app` must be configured to validate Clerk JWTs:

1. The backend should accept JWT tokens from the issuer domain
2. It should verify the token signature using Clerk's public keys
3. The `applicationID` should be set to "convex"

### Step 4: Testing

After setting up the JWT template:

1. Restart the development server: `npm run dev`
2. Sign out and sign back in
3. Try the onboarding flow again
4. Check browser console for any authentication errors

## Error Handling Improvements

The following improvements have been made to handle authentication errors gracefully:

### 1. Enhanced Error Messages (onboarding/page.tsx)

- Clear error messages for 401 Unauthorized errors
- User-friendly messages for network errors
- Helpful tips for resolving authentication issues

### 2. Better Token Retrieval (lib/api-client.ts)

- Fallback to default session token if convex template fails
- Detailed error logging for debugging
- Graceful degradation with informative error messages

### 3. Visual Error Display (onboarding/page.tsx)

- Improved error UI with icons and structured layout
- Contextual help tips based on error type
- Better visual hierarchy for error messages

## Troubleshooting

### "No auth token available" Error

**Cause**: Clerk session not initialized or user not signed in
**Solution**: Ensure user is signed in before attempting API calls

### 401 Unauthorized Errors

**Causes**:
1. JWT template "convex" not created in Clerk dashboard
2. Backend API not configured to validate Clerk tokens
3. Token expired or invalid

**Solutions**:
1. Create the JWT template as described in Step 1
2. Verify backend API configuration
3. Sign out and sign back in to refresh the token

### Network Errors

**Cause**: API endpoint unreachable or CORS issues
**Solution**: Check internet connection and API URL configuration

## Architecture Notes

### Authentication Flow

1. User signs in via Clerk
2. Frontend requests JWT token with 'convex' template
3. Clerk generates token with user claims
4. Frontend sends token in Authorization header
5. Backend validates token using Clerk's public keys
6. Backend processes request if token is valid

### Token Structure

The JWT token generated by Clerk will include:
- `sub`: User ID
- `iss`: Issuer (Clerk domain)
- `aud`: Audience
- `exp`: Expiration time
- `iat`: Issued at time
- Additional user claims (email, etc.)

## Security Considerations

1. Never commit Clerk secret keys to version control
2. Use environment variables for all sensitive configuration
3. Ensure backend validates all JWT tokens properly
4. Implement token refresh logic for long-running sessions
5. Use HTTPS in production for all API communications

## Related Files

- `lib/api-client.ts` - API client with authentication
- `app/(chat)/onboarding/page.tsx` - Onboarding form with error handling
- `convex/auth.config.ts` - Convex authentication configuration
- `.env.local` - Environment variables (not committed)

## Support

If you continue to experience authentication issues:

1. Check Clerk Dashboard for JWT template configuration
2. Verify environment variables are set correctly
3. Check browser console for detailed error messages
4. Review backend API logs for authentication failures
5. Consult Clerk documentation: https://clerk.com/docs/backend-requests/jwt-templates
